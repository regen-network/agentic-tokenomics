#!/usr/bin/env node
import fs from "node:fs";
import path from "node:path";

const repoRoot = process.cwd();
const mechanismsDir = path.join(repoRoot, "mechanisms");
const readmePath = path.join(repoRoot, "README.md");
const checkOnly = process.argv.includes("--check");

function getTitleForMechanism(mechPath) {
  const readme = path.join(mechPath, "README.md");
  if (fs.existsSync(readme)) {
    const first = fs.readFileSync(readme, "utf8").split("\n")[0].trim();
    if (first.startsWith("# ")) return first.slice(2).trim();
  }
  return path.basename(mechPath);
}

function buildIndexLines() {
  if (!fs.existsSync(mechanismsDir)) return [];
  const entries = fs.readdirSync(mechanismsDir, { withFileTypes: true })
    .filter(d => d.isDirectory())
    .map(d => d.name)
    .sort();

  const lines = [];
  for (const name of entries) {
    const mechPath = path.join(mechanismsDir, name);
    const title = getTitleForMechanism(mechPath);
    lines.push(`- [${title}](mechanisms/${name}/)`);
  }
  return lines;
}

function updateReadme(readmeText, indexLines) {
  const begin = "<!-- BEGIN MECHANISMS INDEX -->";
  const end = "<!-- END MECHANISMS INDEX -->";

  const lines = readmeText.split("\n");

  const mechHeadingIdx = lines.findIndex(l => l.trim() === "## Mechanisms");
  if (mechHeadingIdx === -1) {
    throw new Error('README.md missing "## Mechanisms" heading');
  }

  // If markers already exist, replace between them
  const beginIdx = lines.findIndex(l => l.includes(begin));
  const endIdx = lines.findIndex(l => l.includes(end));
  if (beginIdx !== -1 && endIdx !== -1 && endIdx > beginIdx) {
    const before = lines.slice(0, beginIdx + 1);
    const after = lines.slice(endIdx);
    const middle = [
      "",
      "<!-- AUTOGENERATED: run node scripts/build-mechanism-index.mjs -->",
      ...indexLines,
      ""
    ];
    return [...before, ...middle, ...after].join("\n");
  }

  // Otherwise, replace the immediate block after "## Mechanisms" until next heading
  let start = mechHeadingIdx + 1;
  while (start < lines.length && lines[start].trim() === "") start++;

  let stop = start;
  while (stop < lines.length) {
    const t = lines[stop].trim();
    if (t.startsWith("### ") || t.startsWith("## ")) break;
    stop++;
  }

  const before = lines.slice(0, mechHeadingIdx + 1);
  const after = lines.slice(stop);

  const block = [
    "",
    begin,
    "<!-- AUTOGENERATED: run node scripts/build-mechanism-index.mjs -->",
    ...indexLines,
    end,
    ""
  ];

  return [...before, ...block, ...after].join("\n");
}

const indexLines = buildIndexLines();
const original = fs.readFileSync(readmePath, "utf8");
const updated = updateReadme(original, indexLines);

if (checkOnly) {
  if (updated !== original) {
    console.error("README.md mechanism index is out of date. Run: node scripts/build-mechanism-index.mjs");
    process.exit(2);
  }
  console.log("Mechanism index: OK");
  process.exit(0);
}

fs.writeFileSync(readmePath, updated, "utf8");
console.log("Updated README.md mechanism index.");
