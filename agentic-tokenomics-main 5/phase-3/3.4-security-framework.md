# Phase 3.4: Security Audit Framework

## Overview

This document defines the security framework for the agentic tokenomics system, including threat models, attack vector analysis, security invariants, and audit procedures.

---

## Threat Model

### System Boundaries

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                            TRUST BOUNDARY                                    │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                     FULLY TRUSTED ZONE                               │    │
│  │  • Regen Ledger consensus                                           │    │
│  │  • On-chain contract state                                          │    │
│  │  • Validator set (2/3 honest assumption)                            │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                    CONDITIONALLY TRUSTED                             │    │
│  │  • Agent runtime (authenticated, rate-limited)                      │    │
│  │  • MCP servers (authenticated, audited)                             │    │
│  │  • KOI knowledge base (integrity-verified)                          │    │
│  │  • Human operators (with escalation)                                │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
├─────────────────────────────────────────────────────────────────────────────┤
│                            UNTRUSTED ZONE                                    │
│  • External API responses                                                    │
│  • User inputs                                                               │
│  • Third-party data sources                                                  │
│  • Network transport (mitigated by TLS)                                     │
└─────────────────────────────────────────────────────────────────────────────┘
```

### Threat Actors

| Actor | Capability | Motivation | Target Assets |
|-------|------------|------------|---------------|
| Malicious Attester | Submit false attestations | Economic gain | Attestation bonds, reputation |
| Market Manipulator | Large capital, multiple accounts | Profit from manipulation | Credit prices, liquidity |
| Rogue Agent Operator | Access to agent keys | Sabotage, profit | Agent authority, trust |
| External Attacker | Network access, exploit knowledge | Financial gain, disruption | All systems |
| Insider Threat | System access, privileged credentials | Various | Sensitive data, funds |
| Compromised Validator | Up to 1/3 stake | Censorship, manipulation | Consensus, governance |

### Asset Inventory

| Asset | Value | Confidentiality | Integrity | Availability |
|-------|-------|-----------------|-----------|--------------|
| Bonded tokens (M008, M009, M011) | High | Low | Critical | High |
| Reputation scores (M010) | Medium | Low | Critical | Medium |
| Agent private keys | Critical | Critical | Critical | High |
| KOI knowledge data | Medium | Medium | High | Medium |
| Governance decisions | High | Low | Critical | High |
| User credentials | Medium | Critical | High | Medium |

---

## Attack Vector Analysis

### AV-001: Attestation Fraud

```yaml
attack_id: AV-001
name: Attestation Fraud
category: Economic Attack
severity: HIGH

description: |
  Attacker submits false attestation with bond, hoping economic value of
  fraud exceeds bond amount before challenge.

attack_flow:
  1. Attacker creates false attestation with minimum bond
  2. False attestation used to claim benefits (e.g., credit issuance)
  3. Challenge window passes without detection
  4. Attacker recovers bond + fraudulent gains

preconditions:
  - Challenge window too short for verification
  - Bond amount too low relative to potential fraud value
  - Insufficient monitoring/detection mechanisms

mitigations:
  - Dynamic bond sizing based on attestation value
  - Mandatory challenge period scaling with attestation impact
  - Agent-assisted anomaly detection
  - Whistleblower incentives (% of slashed bond)

detection:
  - Anomalous attestation patterns
  - Velocity of attestations from single address
  - Correlation with on-chain benefit claims

residual_risk: MEDIUM (with mitigations)
```

### AV-002: Agent Key Compromise

```yaml
attack_id: AV-002
name: Agent Key Compromise
category: Infrastructure Attack
severity: CRITICAL

description: |
  Attacker gains access to agent signing keys, enabling unauthorized
  transactions or governance actions.

attack_flow:
  1. Attacker compromises agent infrastructure (phishing, exploit, insider)
  2. Extracts agent private keys from memory/storage
  3. Signs malicious transactions using agent authority
  4. Executes unauthorized actions before detection

preconditions:
  - Keys stored in extractable form
  - Insufficient access controls
  - No transaction signing controls

mitigations:
  - Hardware security modules (HSM) for key storage
  - Multi-signature requirements for high-value actions
  - Transaction value limits with human override
  - Key rotation schedule
  - Anomaly detection on agent behavior

detection:
  - Unusual transaction patterns
  - Geographic anomalies
  - Out-of-hours activity
  - Velocity checks

residual_risk: MEDIUM (with HSM + multi-sig)
```

### AV-003: Oracle/MCP Manipulation

```yaml
attack_id: AV-003
name: Oracle/MCP Data Manipulation
category: Data Integrity Attack
severity: HIGH

description: |
  Attacker manipulates data provided by MCP servers to influence agent
  decisions or smart contract execution.

attack_flow:
  1. Attacker compromises MCP server or intercepts traffic
  2. Modifies responses to agent queries
  3. Agent makes decisions based on false data
  4. Incorrect recommendations/actions executed

preconditions:
  - Single MCP server trust
  - No response verification
  - Weak authentication

mitigations:
  - Multiple independent data sources
  - Cryptographic response signatures
  - Data freshness verification
  - Anomaly detection on data patterns
  - Consensus across multiple oracles

detection:
  - Data consistency checks
  - Historical deviation alerts
  - Cross-source validation failures

residual_risk: MEDIUM (with multi-source validation)
```

### AV-004: Governance Attack

```yaml
attack_id: AV-004
name: Agent-Assisted Governance Attack
category: Governance Attack
severity: HIGH

description: |
  Attacker exploits agent's proposal/recommendation authority to push
  malicious governance changes.

attack_flow:
  1. Attacker crafts proposal that appears legitimate
  2. Manipulates inputs to agent (KOI data, community signals)
  3. Agent recommends approval based on false context
  4. Proposal passes with agent endorsement

preconditions:
  - Agent has proposal submission authority
  - Insufficient human review window
  - Community trusts agent recommendations

mitigations:
  - Layer 2+ always requires human review window
  - Confidence threshold for auto-submission
  - Multiple agent consensus for proposals
  - Escalation triggers for unusual proposals
  - Community cooling-off periods

detection:
  - Unusual proposal characteristics
  - Low community engagement
  - Agent confidence anomalies

residual_risk: LOW (with Layer 2+ controls)
```

### AV-005: Escrow Manipulation

```yaml
attack_id: AV-005
name: Service Escrow Manipulation
category: Economic Attack
severity: HIGH

description: |
  Provider or client manipulates escrow to receive funds without
  fulfilling obligations.

attack_flow:
  Provider attack:
    1. Provider creates agreement with vague milestones
    2. Claims milestone completion with insufficient evidence
    3. Receives funds without delivering
  Client attack:
    1. Client receives service
    2. Disputes milestone with false claims
    3. Recovers escrowed funds while keeping service

preconditions:
  - Vague milestone definitions
  - Insufficient evidence requirements
  - Weak arbitration process

mitigations:
  - Clear milestone criteria in contract
  - Evidence IRI requirements
  - Independent arbitration DAO
  - Reputation system consequences
  - Partial release schedules

detection:
  - Dispute frequency analysis
  - Provider/client reputation patterns
  - Milestone evidence verification

residual_risk: MEDIUM (with arbitration + reputation)
```

### AV-006: Sybil Attack on Reputation

```yaml
attack_id: AV-006
name: Reputation System Sybil Attack
category: Identity Attack
severity: MEDIUM

description: |
  Attacker creates multiple identities to artificially inflate
  reputation signals.

attack_flow:
  1. Attacker creates multiple addresses
  2. Stakes minimal amounts across addresses
  3. Mutual endorsement between sybil accounts
  4. Inflated reputation used to gain trust

preconditions:
  - Low cost of identity creation
  - No stake-weighted signals
  - Linear reputation aggregation

mitigations:
  - Stake-weighted signal weights
  - Quadratic aggregation
  - On-chain history requirements
  - Social graph analysis
  - Proof of unique identity (optional)

detection:
  - Cluster analysis of endorsement patterns
  - Account age/activity correlation
  - Mutual endorsement detection

residual_risk: LOW (with stake-weighting + graph analysis)
```

---

## Security Invariants

### Smart Contract Invariants

```rust
// Attestation Bond Contract Invariants

/// INV-001: Bond conservation
/// Total locked bonds must equal sum of active attestation bonds
invariant bond_conservation {
    TOTAL_LOCKED == sum(attestation.bond for attestation in ATTESTATIONS where attestation.status in [Active, Challenged])
}

/// INV-002: State transitions are monotonic
/// Attestations can only progress forward in lifecycle
invariant state_monotonic {
    forall attestation:
        old(attestation.status) == Active => new(attestation.status) in [Active, Challenged, Released, Slashed]
        old(attestation.status) == Challenged => new(attestation.status) in [Challenged, Released, Slashed]
        old(attestation.status) in [Released, Slashed] => new(attestation.status) == old(attestation.status)
}

/// INV-003: Challenge window respected
/// Challenges only accepted within window
invariant challenge_window {
    forall challenge:
        challenge.submitted_at < attestation.challenge_window_closes_at
}

/// INV-004: Only arbiter can resolve disputes
/// Challenged attestations can only be resolved by designated arbiter
invariant arbiter_authority {
    forall resolution:
        resolution.status in [Released, Slashed] AND attestation.status == Challenged
        => resolution.sender == CONFIG.arbiter_dao
}

/// INV-005: Bond minimum enforced
/// All attestations must meet minimum bond requirement
invariant minimum_bond {
    forall attestation:
        attestation.bond >= CONFIG.min_bond
}
```

```rust
// Service Escrow Contract Invariants

/// INV-006: Escrow conservation
/// Escrowed funds must equal sum of milestone values
invariant escrow_conservation {
    agreement.escrow_amount == sum(milestone.amount for milestone in agreement.milestones where milestone.status != Completed)
}

/// INV-007: Milestone progression
/// Milestones must complete in order
invariant milestone_order {
    forall agreement:
        forall i < j:
            milestones[j].status == Completed => milestones[i].status == Completed
}

/// INV-008: Dispute resolution authority
/// Only arbiter can resolve disputes
invariant dispute_authority {
    forall milestone:
        milestone.status == Disputed AND new(milestone.status) in [Completed, Rejected]
        => msg.sender == agreement.arbiter
}
```

```rust
// Reputation Registry Invariants

/// INV-009: Weight bounds
/// Signal weights must be within valid range
invariant weight_bounds {
    forall signal:
        0 <= signal.weight <= 1.0
}

/// INV-010: Self-endorsement prevention
/// Cannot endorse own address
invariant no_self_endorsement {
    forall signal:
        signal.signaler != signal.subject_id (when subject_type == "address")
}

/// INV-011: Stake requirement
/// Signalers must have minimum stake
invariant stake_requirement {
    forall signal:
        get_staked_amount(signal.signaler) >= CONFIG.min_stake_to_signal
}
```

### Agent Behavioral Invariants

```yaml
# Agent Behavioral Invariants

INV-A001:
  name: Confidence threshold enforcement
  description: Agent must not auto-execute actions when confidence < threshold
  condition: decision.confidence < escalation_threshold => action.type != "execute"
  monitoring: Log all decisions with confidence, alert on violations

INV-A002:
  name: Rate limit compliance
  description: Agent must respect MCP rate limits
  condition: requests_per_minute <= configured_rate_limit
  monitoring: Request counter with sliding window

INV-A003:
  name: Transaction value limits
  description: Agent cannot sign transactions exceeding value limit without multi-sig
  condition: tx.value > agent_tx_limit => requires_human_cosign
  monitoring: Transaction value tracking, alert on limit approach

INV-A004:
  name: Audit trail completeness
  description: All decisions must be logged with full context
  condition: decision => exists(audit_log_entry)
  monitoring: Audit log completeness checks

INV-A005:
  name: Escalation path availability
  description: Human escalation path must always be available
  condition: escalation_requested => human_notified_within_sla
  monitoring: Escalation latency tracking
```

---

## Security Audit Checklist

### Smart Contract Audit

```markdown
## Pre-Audit Preparation

- [ ] Code freeze complete
- [ ] Full test suite passing
- [ ] Documentation complete
- [ ] Known issues documented

## Static Analysis

### Automated Tools
- [ ] Slither analysis (all critical findings addressed)
- [ ] Mythril symbolic execution
- [ ] Semgrep custom rules
- [ ] Rust clippy (for CosmWasm)
- [ ] cargo-audit for dependencies

### Manual Review
- [ ] Access control review
  - [ ] Admin functions properly protected
  - [ ] Role-based permissions correct
  - [ ] Ownership transfer secure

- [ ] Economic logic review
  - [ ] Bond calculations correct
  - [ ] Fee calculations correct
  - [ ] No integer overflow/underflow
  - [ ] Rounding handled appropriately

- [ ] State management review
  - [ ] State transitions valid
  - [ ] No state corruption paths
  - [ ] Proper initialization

- [ ] External call review
  - [ ] Reentrancy protections
  - [ ] Return value checks
  - [ ] Gas limitations considered

## CosmWasm-Specific Checks

- [ ] No unbounded iteration
- [ ] Proper use of `deps.querier`
- [ ] Reply handling correct
- [ ] Submessage ordering
- [ ] Proper error types

## Test Coverage

- [ ] Unit test coverage > 90%
- [ ] Integration test coverage for critical paths
- [ ] Fuzzing results reviewed
- [ ] Edge cases tested

## Documentation

- [ ] All public functions documented
- [ ] State transitions documented
- [ ] Invariants documented
- [ ] Admin procedures documented
```

### Agent Security Audit

```markdown
## Infrastructure Security

- [ ] Key management
  - [ ] HSM usage for signing keys
  - [ ] Key rotation procedures
  - [ ] Backup and recovery tested

- [ ] Network security
  - [ ] TLS everywhere
  - [ ] mTLS for MCP connections
  - [ ] No exposed internal endpoints

- [ ] Container security
  - [ ] Minimal base images
  - [ ] No root processes
  - [ ] Read-only filesystems where possible
  - [ ] Resource limits configured

## Application Security

- [ ] Input validation
  - [ ] All external inputs validated
  - [ ] Injection prevention
  - [ ] Size limits enforced

- [ ] Authentication & authorization
  - [ ] API authentication verified
  - [ ] Permission model correct
  - [ ] Session management secure

- [ ] Secrets management
  - [ ] No hardcoded secrets
  - [ ] Secrets properly injected
  - [ ] Secrets rotatable

## Behavioral Security

- [ ] Decision logging
  - [ ] All decisions logged
  - [ ] Context preserved
  - [ ] Logs tamper-evident

- [ ] Rate limiting
  - [ ] MCP rate limits enforced
  - [ ] Transaction rate limits
  - [ ] Resource consumption limits

- [ ] Escalation paths
  - [ ] Human review triggers working
  - [ ] Notification delivery verified
  - [ ] Timeout handling correct
```

### MCP Integration Security

```markdown
## Authentication

- [ ] API key rotation supported
- [ ] mTLS configuration correct
- [ ] Token expiration handled

## Data Integrity

- [ ] Response signature verification
- [ ] Timestamp freshness checks
- [ ] Cross-source validation

## Availability

- [ ] Failover mechanisms
- [ ] Graceful degradation
- [ ] Circuit breakers configured

## Privacy

- [ ] Minimal data exposure
- [ ] PII handling correct
- [ ] Audit log retention policy
```

---

## Incident Response Plan

### Severity Classification

| Severity | Definition | Response Time | Escalation |
|----------|------------|---------------|------------|
| P0 - Critical | Active exploit, fund loss risk | Immediate | CEO, Security Lead, Legal |
| P1 - High | Vulnerability discovered, no active exploit | < 1 hour | Security Lead, Engineering Lead |
| P2 - Medium | Security issue, low immediate risk | < 4 hours | Security Team |
| P3 - Low | Minor issue, hardening opportunity | < 24 hours | Security Team |

### Response Procedures

```yaml
P0_Critical_Response:
  immediate_actions:
    - Activate incident channel
    - Pause affected contracts (if possible)
    - Disable affected agents
    - Preserve evidence

  investigation:
    - Identify attack vector
    - Assess scope and impact
    - Identify affected users/funds

  containment:
    - Implement immediate fix or disable
    - Block attacker addresses (if identified)
    - Secure remaining assets

  communication:
    - Internal notification (< 15 min)
    - Community notification (< 1 hour for fund-affecting)
    - Regulatory notification (if required)

  recovery:
    - Deploy fix after review
    - Gradual service restoration
    - User compensation plan (if applicable)

  post_incident:
    - Root cause analysis
    - Process improvement
    - Public post-mortem
```

### Emergency Contacts

```yaml
security_team:
  primary: security@regen.network
  pager: +1-XXX-XXX-XXXX

on_call_rotation:
  schedule: 24/7
  escalation_path:
    1. On-call engineer (5 min)
    2. Security lead (15 min)
    3. CTO (30 min)

external_contacts:
  legal: legal@regen.network
  auditor: security-firm@example.com
  bug_bounty: immunefi.com/bounty/regen
```

---

## Bug Bounty Program

### Scope

```yaml
in_scope:
  smart_contracts:
    - attestation-bond
    - service-escrow
    - reputation-registry
    - marketplace-curation

  infrastructure:
    - Agent runtime (critical functions only)
    - MCP servers (authentication bypass, data manipulation)

  websites:
    - app.regen.network (authentication, authorization)
    - api.regen.network (data exposure)

out_of_scope:
  - Third-party services
  - Social engineering
  - Physical attacks
  - DoS (unless protocol-level)
```

### Rewards

| Severity | Smart Contract | Infrastructure | Web |
|----------|---------------|----------------|-----|
| Critical | $50,000 - $100,000 | $20,000 - $50,000 | $10,000 - $25,000 |
| High | $10,000 - $50,000 | $5,000 - $20,000 | $2,500 - $10,000 |
| Medium | $2,500 - $10,000 | $1,000 - $5,000 | $500 - $2,500 |
| Low | $500 - $2,500 | $250 - $1,000 | $100 - $500 |

### Reporting Process

```yaml
reporting:
  platform: Immunefi
  url: https://immunefi.com/bounty/regen

  required_info:
    - Vulnerability description
    - Steps to reproduce
    - Impact assessment
    - Suggested fix (optional)

  response_sla:
    initial_response: 24 hours
    triage: 72 hours
    resolution_timeline: case-by-case

  disclosure:
    policy: coordinated
    timeline: 90 days after fix
```

---

## Compliance Requirements

### Data Protection

```yaml
gdpr_compliance:
  personal_data:
    - Agent decision logs (may contain addresses)
    - User preferences
    - Escalation records

  requirements:
    - Data minimization
    - Purpose limitation
    - Storage limitation
    - Right to access
    - Right to erasure (where technically feasible)

  implementation:
    - Pseudonymization of addresses in logs
    - Retention policies (30 days for operational, 7 years for audit)
    - Data export functionality
```

### Financial Regulations

```yaml
aml_considerations:
  high_value_transactions:
    - Escrow agreements > threshold
    - Bond releases > threshold

  monitoring:
    - Transaction pattern analysis
    - Address screening (if required)
    - Suspicious activity reporting

  note: |
    Specific requirements depend on jurisdiction and regulatory
    classification. Legal review required before mainnet launch.
```

---

## Summary

| Security Area | Status | Priority |
|---------------|--------|----------|
| Threat Model | Complete | - |
| Attack Vectors | 6 documented | - |
| Invariants | 11 specified | - |
| Audit Checklist | Ready | Pre-mainnet |
| Incident Response | Defined | Pre-mainnet |
| Bug Bounty | Designed | Post-audit |
