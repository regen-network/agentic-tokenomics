# Phase 2.2: Agentic Workflow Design

## Overview

This specification defines 12 agentic workflows across 4 agent personas, following the OODA (Observe-Orient-Decide-Act) loop pattern integrated with the 4-layer governance model.

---

## Workflow Architecture

```
┌────────────────────────────────────────────────────────────────────────┐
│                        AGENT ORCHESTRATION LAYER                        │
│                           (ElizaOS Runtime)                             │
├────────────────────────────────────────────────────────────────────────┤
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  ┌─────────────┐ │
│  │   Registry   │  │  Governance  │  │    Market    │  │  Validator  │ │
│  │   Reviewer   │  │   Analyst    │  │   Monitor    │  │   Monitor   │ │
│  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘  └──────┬──────┘ │
├─────────┴─────────────────┴─────────────────┴─────────────────┴────────┤
│                          SHARED SERVICES LAYER                          │
│  ┌────────────┐  ┌────────────┐  ┌────────────┐  ┌────────────┐        │
│  │ KOI MCP    │  │ Ledger MCP │  │ Notification│  │ TX Builder │        │
│  │ (Knowledge)│  │ (On-Chain) │  │ Service     │  │ Service    │        │
│  └────────────┘  └────────────┘  └────────────┘  └────────────┘        │
└────────────────────────────────────────────────────────────────────────┘
```

---

## AGENT 1: REGISTRY REVIEWER

### WF-RR-01: Credit Class Application Review

```yaml
workflow_id: WF-RR-01
name: Credit Class Application Review
trigger:
  event: MsgProposeClassCreator
  source: x/ecocredit (enhanced per M001-ENH)
governance_layer: Layer 2 (Agentic + Oversight)

ooda_loop:
  observe:
    - fetch_proposal_metadata (ledger_mcp)
    - resolve_methodology_document (koi_mcp)
    - fetch_proposer_reputation (x/reputation)

  orient:
    - methodology_completeness_check (additionality, baseline, MRV, permanence)
    - duplicate_detection (cosine_similarity < 0.85)
    - credit_type_validation
    - risk_assessment

  decide:
    - if completeness >= 0.9 AND risk < 0.3: recommend_approve (confidence: 0.95)
    - if completeness >= 0.7 AND risk < 0.5: recommend_conditional (confidence: 0.75)
    - else: recommend_reject (confidence: 0.85)

  act:
    - submit_agent_score
    - create_governance_proposal (if approved)
    - notify stakeholders
    - create_koi_audit_object

sla:
  response_time: 24h
  confidence_threshold: 0.7
```

### WF-RR-02: Project Registration Validation

```yaml
workflow_id: WF-RR-02
name: Project Registration Validation
trigger:
  event: MsgCreateProject
governance_layer: Layer 1 (Fully Automated) / Layer 2 (if anomaly)

ooda_loop:
  observe:
    - fetch_project_data
    - resolve_project_metadata
    - fetch_class_requirements
    - satellite_baseline_check (external oracle)

  orient:
    - jurisdiction_validation
    - boundary_validation (valid geojson, area limits, no overlap)
    - baseline_plausibility (tolerance: 15%)
    - admin_authorization

  decide:
    - all_pass: auto_approve (Layer 1)
    - boundary/jurisdiction_invalid: reject (Layer 1)
    - baseline_mismatch > 15%: escalate (Layer 2)

  act:
    - log_validation_result
    - emit events / notify stakeholders

sla:
  response_time: 1h (automated), 48h (escalated)
```

### WF-RR-03: Credit Batch Issuance Verification

```yaml
workflow_id: WF-RR-03
name: Credit Batch Issuance Verification
trigger:
  event: MsgCreateBatch (pending verification)
governance_layer: Layer 2 (Agentic + Oversight)

ooda_loop:
  observe:
    - fetch_batch_request
    - fetch_monitoring_report
    - fetch_project_history
    - cross_reference_mrv

  orient:
    - quantity_validation (within capacity, consistent with MRV)
    - verification_validation (authorized verifier, recent, compliant)
    - double_counting_check
    - risk_scoring

  decide:
    - low_risk: recommend_approve (24h human window)
    - minor_deviations: recommend_conditional (72h human window)
    - high_risk: escalate_to_human (Layer 3)

  act:
    - submit_verification_attestation
    - start_human_override_window
    - notify stakeholders
```

---

## AGENT 2: GOVERNANCE ANALYST

### WF-GA-01: Proposal Analysis & Summarization

```yaml
workflow_id: WF-GA-01
name: Proposal Analysis & Summarization
trigger:
  event: ProposalSubmitted
governance_layer: Layer 1 (Fully Automated - informational)

ooda_loop:
  observe:
    - fetch_proposal (ledger_mcp)
    - fetch_proposer_history
    - fetch_related_discussions (koi_mcp)
    - fetch_similar_proposals

  orient:
    - proposal_classification (parameter, upgrade, spend, registry, text)
    - impact_analysis (economic, governance, technical)
    - sentiment_analysis (forum discussions)
    - precedent_analysis

  decide:
    - generate_summary (title, category, tldr, impact, sentiment, context)
    - determine_distribution_channels

  act:
    - create_koi_object (ProposalAnalysis)
    - post_to_forum
    - post_to_discord
    - post_to_twitter (if high impact)
    - schedule_voting_reminder

sla:
  response_time: 2h from proposal submission
```

### WF-GA-02: Voting Outcome Prediction & Alerts

```yaml
workflow_id: WF-GA-02
name: Voting Outcome Prediction & Alerts
trigger:
  event: VoteCast OR periodic(every 6h during voting)
governance_layer: Layer 1 (Fully Automated - informational)

ooda_loop:
  observe:
    - fetch_current_tally
    - fetch_voting_power_distribution
    - fetch_voting_timeline

  orient:
    - turnout_projection (linear regression)
    - outcome_projection (optimistic, pessimistic, historical scenarios)
    - quorum_analysis

  decide:
    - generate_status_update
    - determine_alert_level (CRITICAL, HIGH, NORMAL)

  act:
    - update_koi_object
    - send_alerts (if CRITICAL/HIGH)
    - log_prediction

sla:
  update_frequency: 6h (normal), 1h (final 48h), 15m (final 6h)
```

### WF-GA-03: Post-Vote Analysis & Reporting

```yaml
workflow_id: WF-GA-03
name: Post-Vote Analysis & Reporting
trigger:
  event: ProposalFinalized
governance_layer: Layer 1 (Fully Automated)

ooda_loop:
  observe:
    - fetch_final_results
    - fetch_all_votes
    - fetch_prediction_log

  orient:
    - voting_pattern_analysis
    - prediction_accuracy_assessment
    - trend_analysis

  decide:
    - generate_post_mortem

  act:
    - create_koi_object (ProposalPostMortem)
    - post_to_forum
    - update_governance_dashboard
    - schedule_impact_monitoring (if parameter change)
```

---

## AGENT 3: MARKET MONITOR

### WF-MM-01: Price Anomaly Detection

```yaml
workflow_id: WF-MM-01
name: Price Anomaly Detection
trigger:
  event: SellOrderCreated OR SellOrderFilled
governance_layer: Layer 1 (alerts) / Layer 2 (if action needed)

ooda_loop:
  observe:
    - fetch_order_details
    - fetch_market_context
    - fetch_external_prices (oracle)

  orient:
    - price_analysis (vs batch, class, external medians)
    - anomaly_scoring (z-score, threshold: 2.5)
    - context_assessment

  decide:
    - anomaly < 2.0: log_normal
    - anomaly 2.0-3.5: flag_for_monitoring
    - anomaly >= 3.5: escalate_potential_manipulation

  act:
    - log_observation
    - add_to_watchlist (if flagged)
    - create_investigation_ticket (if escalated)
    - notify_market_committee
```

### WF-MM-02: Liquidity Monitoring & Reporting

```yaml
workflow_id: WF-MM-02
name: Liquidity Monitoring & Reporting
trigger:
  event: periodic(every 1h) OR significant_trade(volume > $10k)
governance_layer: Layer 1 (Fully Automated)

ooda_loop:
  observe:
    - fetch_order_book_state
    - fetch_trade_history
    - fetch_basket_state

  orient:
    - liquidity_metrics (listed value, bid-ask spread, depth)
    - trend_analysis
    - health_assessment

  decide:
    - generate_market_report

  act:
    - create_koi_object (MarketReport)
    - update_market_dashboard
    - alert_if_health_low
    - post_weekly_summary
```

### WF-MM-03: Retirement Pattern Analysis

```yaml
workflow_id: WF-MM-03
name: Retirement Pattern Analysis
trigger:
  event: MsgRetire
governance_layer: Layer 1 (Fully Automated)

ooda_loop:
  observe:
    - fetch_retirement_details
    - fetch_batch_context
    - fetch_retiree_history

  orient:
    - retirement_metrics
    - demand_signal_extraction
    - impact_quantification

  decide:
    - update_demand_index
    - generate_retirement_insights

  act:
    - update_koi_index
    - update_dashboard
    - create_case_study (if significant)
```

---

## AGENT 4: VALIDATOR MONITOR

### WF-VM-01: Validator Performance Tracking

```yaml
workflow_id: WF-VM-01
name: Validator Performance Tracking
trigger:
  event: periodic(every_block) OR slash_event
governance_layer: Layer 1 (Fully Automated)

ooda_loop:
  observe:
    - fetch_validator_set
    - fetch_signing_info
    - fetch_commission_changes

  orient:
    - performance_scoring (uptime, governance participation, stability)
    - risk_assessment (concentration, downtime)

  decide:
    - update_validator_scores
    - generate_alerts (high risk, governance inactive, commission spike)

  act:
    - update_koi_index
    - update_staking_dashboard
    - notify_delegators (if high risk)
```

### WF-VM-02: Delegation Flow Analysis

```yaml
workflow_id: WF-VM-02
name: Delegation Flow Analysis
trigger:
  event: MsgDelegate OR MsgUndelegate OR MsgRedelegate
governance_layer: Layer 1 (Fully Automated)

ooda_loop:
  observe:
    - fetch_delegation_event
    - fetch_flow_context
    - fetch_delegator_profile

  orient:
    - flow_metrics (net flow, redistribution, concentration change)
    - whale_tracking
    - trend_analysis

  decide:
    - generate_flow_report

  act:
    - log_delegation_flow
    - update_staking_dashboard
    - notify_if_whale_movement
    - generate_weekly_staking_report
```

### WF-VM-03: Network Decentralization Monitoring

```yaml
workflow_id: WF-VM-03
name: Network Decentralization Monitoring
trigger:
  event: periodic(daily) OR validator_set_change
governance_layer: Layer 1 (alerts) / Layer 3 (if action needed)

ooda_loop:
  observe:
    - fetch_power_distribution
    - fetch_geographic_distribution
    - fetch_historical_distribution

  orient:
    - decentralization_metrics (Nakamoto, Gini, geographic diversity)
    - trend_analysis
    - risk_assessment

  decide:
    - metrics_healthy: log_status
    - warning_threshold: generate_warning
    - critical_threshold: escalate_for_action

  act:
    - update_dashboard
    - create_koi_object
    - notify_community (if warning)
    - notify_core_team (if critical)
```

---

## Summary

| Agent | Workflows | Automation Level | Primary MCP |
|-------|-----------|------------------|-------------|
| Registry Reviewer | 3 | Layer 1-2 | KOI + Ledger |
| Governance Analyst | 3 | Layer 1 | Ledger + KOI |
| Market Monitor | 3 | Layer 1-2 | Ledger |
| Validator Monitor | 3 | Layer 1-3 | Ledger |

**Total Workflows**: 12
**Average Automation**: ~75% (Layer 1-2)
**Human Escalation Points**: 8 defined triggers
