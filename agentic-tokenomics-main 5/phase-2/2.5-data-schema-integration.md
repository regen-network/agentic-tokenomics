# Phase 2.5: Data Schema & Integration Specification

## Overview

This specification defines data schemas, API contracts, and integration patterns for the agentic tokenomics system.

---

## Core Data Schemas

### Agent State (PostgreSQL)

```sql
-- Agent Identity
CREATE TABLE agents (
    agent_id UUID PRIMARY KEY,
    name VARCHAR(64) NOT NULL UNIQUE,
    type VARCHAR(32) NOT NULL,
    status VARCHAR(16) NOT NULL DEFAULT 'active',
    character_hash BYTEA NOT NULL,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    config JSONB NOT NULL DEFAULT '{}'
);

-- Agent Memory
CREATE TABLE agent_memories (
    memory_id UUID PRIMARY KEY,
    agent_id UUID REFERENCES agents(agent_id),
    memory_type VARCHAR(32) NOT NULL,
    content JSONB NOT NULL,
    embedding VECTOR(1024),
    importance_score FLOAT DEFAULT 0.5,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    expires_at TIMESTAMP WITH TIME ZONE,
    metadata JSONB DEFAULT '{}'
);

CREATE INDEX idx_memories_embedding ON agent_memories
  USING ivfflat (embedding vector_cosine_ops);

-- Workflow Execution Log
CREATE TABLE workflow_executions (
    execution_id UUID PRIMARY KEY,
    agent_id UUID REFERENCES agents(agent_id),
    workflow_id VARCHAR(32) NOT NULL,
    trigger_type VARCHAR(16) NOT NULL,
    trigger_data JSONB NOT NULL,
    status VARCHAR(16) NOT NULL,
    started_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    completed_at TIMESTAMP WITH TIME ZONE,
    result JSONB,
    governance_layer INTEGER,
    escalated_to VARCHAR(64),
    audit_koi_iri TEXT
);

-- Agent Decisions (Audit Trail)
CREATE TABLE agent_decisions (
    decision_id UUID PRIMARY KEY,
    execution_id UUID REFERENCES workflow_executions(execution_id),
    agent_id UUID REFERENCES agents(agent_id),
    decision_type VARCHAR(32) NOT NULL,
    subject_type VARCHAR(32) NOT NULL,
    subject_id VARCHAR(128) NOT NULL,
    decision VARCHAR(32) NOT NULL,
    confidence FLOAT NOT NULL,
    rationale TEXT NOT NULL,
    evidence JSONB NOT NULL,
    human_override BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

### KOI Object Schemas

```yaml
# Agent Decision Audit Object
agent_decision_audit:
  type: "regen.agent.decision"
  content:
    agent_id: string
    workflow_id: string
    execution_id: string
    decision_type: enum[RECOMMEND, ESCALATE, ALERT, PROPOSE]
    subject:
      type: string
      id: string
      snapshot: object
    analysis:
      inputs: object
      observations: array
      confidence: float
    decision:
      action: string
      rationale: string
      evidence_iris: array[IRI]
    outcome:
      executed: boolean
      human_override: boolean
  provenance:
    data_sources: array[IRI]
    model_version: string

# Governance Analysis Object
governance_analysis:
  type: "regen.governance.analysis"
  content:
    proposal_id: string
    analysis_type: enum[PRE_VOTE, DURING_VOTE, POST_VOTE]
    summary:
      title: string
      category: string
      tldr: string
    impact_assessment:
      economic: object
      governance: object
      technical: object
    community_sentiment:
      positive_ratio: float
      key_concerns: array[string]
    prediction: (optional)
      projected_outcome: enum[PASS, FAIL, UNCERTAIN]
      confidence: float

# Market Report Object
market_report:
  type: "regen.market.report"
  content:
    period: {start: datetime, end: datetime}
    summary:
      total_volume: object
      health_score: float
    metrics:
      by_credit_type: array
      top_movers: array
    anomalies_detected: array
    trends:
      volume_trend: enum[UP, DOWN, STABLE]
```

### On-Chain Structures (Protobuf)

```protobuf
// Agent Score (for M001-ENH)
message AgentScore {
  string agent_id = 1;
  float score = 2;
  float confidence = 3;
  string recommendation = 4;
  string rationale_iri = 5;
  google.protobuf.Timestamp scored_at = 6;
}

// Attestation Bond (for M008)
message AttestationBond {
  uint64 id = 1;
  string attester = 2;
  string attestation_iri = 3;
  string attestation_type = 4;
  cosmos.base.v1beta1.Coin bond_amount = 5;
  BondStatus status = 6;
  google.protobuf.Timestamp lock_expires_at = 7;
}

// Service Agreement (for M009)
message ServiceAgreement {
  uint64 id = 1;
  string client = 2;
  string provider = 3;
  cosmos.base.v1beta1.Coin escrow_amount = 4;
  repeated Milestone milestones = 5;
  AgreementStatus status = 6;
}

// Reputation Signal (for M010)
message ReputationSignal {
  uint64 id = 1;
  string signaler = 2;
  string subject_type = 3;
  string subject_id = 4;
  string category = 5;
  uint32 endorsement_level = 6;
  float weight = 7;
}

// Curated Collection (for M011)
message CuratedCollection {
  uint64 id = 1;
  string curator = 2;
  string name = 3;
  cosmos.base.v1beta1.Coin bond = 4;
  CurationCriteria criteria = 5;
  repeated string member_batches = 6;
}
```

---

## API Specifications

### MCP Tools Interface

```yaml
koi_mcp_tools:
  search:
    parameters: [query, intent, limit, source, published_from, sort_by]
    returns: {results: array[SearchResult], metadata: object}

  resolve_entity:
    parameters: [label, type_hint, limit]
    returns: {matches: array[EntityMatch]}

  sparql_query:
    parameters: [query, limit, format]
    returns: {results: array[object]}

ledger_mcp_tools:
  list_classes:
    parameters: [limit, offset]
    returns: {classes: array[CreditClass], pagination: Pagination}

  list_governance_proposals:
    parameters: [status, limit, page]
    returns: {proposals: array[Proposal]}

  list_sell_orders:
    parameters: [batch_denom, seller, limit]
    returns: {orders: array[SellOrder]}

tx_builder_mcp_tools:
  build_proposal:
    parameters: [type, content, depositor, deposit]
    returns: {unsigned_tx: object, simulation_result: object}

  simulate_tx:
    parameters: [tx]
    returns: {gas_used: integer, events: array}
```

### Inter-Agent Communication

```yaml
agent_message:
  message_id: string
  from_agent: string
  to_agent: string | "broadcast"
  type: enum[REQUEST, RESPONSE, EVENT, DELEGATION]
  correlation_id: string
  payload:
    action: string
    data: object
  priority: enum[LOW, NORMAL, HIGH, URGENT]
  timestamp: datetime
```

### External API Endpoints

```yaml
/agents:
  GET: List all agents with status

/agents/{agent_id}/status:
  GET: Agent status and metrics

/agents/{agent_id}/decisions:
  GET: Decision history with filters

/workflows/{execution_id}:
  GET: Workflow execution details

/governance/analysis/{proposal_id}:
  GET: Agent governance analysis

/market/reports:
  GET: Market reports (daily/weekly/monthly)

/escalations:
  GET: Pending escalations
  POST /{id}/resolve: Resolve escalation (human action)
```

---

## Integration Patterns

### Event-Driven Integration

```yaml
event_sources:
  blockchain_events:
    source: Tendermint WebSocket
    events: [EventCreateClass, EventProposalSubmitted, EventVote, etc.]
    adapter: websocket_listener
    processing: parse → enrich → route → log

  koi_events:
    source: KOI Event Bridge
    events: [DocumentIngested, EntityCreated]
    adapter: redis_stream_consumer
    processing: filter → update_memories → trigger_workflows

event_routing:
  - event: EventCreateClass → agents: [AGENT-001] → workflow: WF-RR-01
  - event: EventProposalSubmitted → agents: [AGENT-002] → workflow: WF-GA-01
  - event: EventSellOrderCreated → agents: [AGENT-003] → workflow: WF-MM-01
```

### Data Synchronization

```yaml
ledger_to_cache:
  strategy: incremental_sync
  frequency: every_block
  entities: [classes, projects, batches, proposals, validators]
  storage: redis (ttl: 1 block)

koi_to_agent_memory:
  strategy: relevance_based
  trigger: on_workflow_start OR daily
  process: determine_relevant → fetch → embed → upsert

agent_decisions_to_koi:
  strategy: immediate_write
  trigger: on_decision_made
  process: format → hash → sign → submit
```

### Error Handling

```yaml
mcp_failures:
  koi_unavailable:
    response: use_cached_data, log_degraded, alert_if_prolonged
    recovery: reconnect_with_backoff

  ledger_unavailable:
    response: use_cached_state, pause_workflows, alert_immediately
    recovery: reconnect_with_backoff

workflow_failures:
  llm_error:
    response: retry_with_fallback (3 attempts), escalate_if_failed

  invalid_state:
    response: rollback, create_incident_report, notify_ops

  timeout:
    response: checkpoint, escalate_if_critical, schedule_retry
```

---

## Summary

| Component | Technology | Purpose |
|-----------|------------|---------|
| Agent State | PostgreSQL + pgvector | Memory, decisions, workflows |
| Knowledge | Apache Jena + KOI | Semantic search, entities |
| On-Chain | Regen Ledger | State of truth |
| Cache | Redis | Performance, queues |
| Audit | KOI Objects | Permanent provenance |
